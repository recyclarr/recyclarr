---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Qodana

on:
  workflow_dispatch:
  push:
    # Explicitly specifying this results in tags being ignored
    branches: ["**"]
    paths:
      - .github/workflows/qodana.yml
      - qodana.yaml
      - "**.props"
      - "src/**"
      - "tests/**"
      - "ci/**"

  pull_request:
    paths:
      - .github/workflows/qodana.yml
      - qodana.yaml
      - "**.props"
      - "src/**"
      - "tests/**"
      - "ci/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: read

jobs:
  #############################################
  pre-check:
    uses: ./.github/workflows/reusable-precheck.yml

  #############################################
  qodana:
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'
    name: Qodana Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0 # avoid shallow clone for better analysis

      - name: Setup .NET & Tools
        uses: ./.github/actions/setup-dotnet

      # Skip Qodana on fork PRs since QODANA_TOKEN secret is unavailable (GitHub security).
      # Qodana requires the token for cloud connectivity and will fail without it.
      - name: Run Qodana Analysis
        if: |
          github.event.pull_request.head.repo.full_name == github.repository ||
          github.event_name != 'pull_request'
        uses: JetBrains/qodana-action@27de2a744479d1d731934eeaf79287575ebc5dd3 # v2025.2.1
        with:
          upload-result: true
          # Only save cache on default branch to prevent cache storage explosion.
          # Feature branches can still read from master's cache for performance benefits.
          cache-default-branch-only: true
        env:
          QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@c503cb4fbb5ac9c4ff92454b2613f5bf931403e5 # v3.31.1
        if: |
          (success() || failure()) &&
          (github.event.pull_request.head.repo.full_name == github.repository ||
          github.event_name != 'pull_request')
        with:
          sarif_file: ${{ runner.temp }}/qodana/results/qodana.sarif.json
          category: qodana
