---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Qodana

on:
  workflow_dispatch:
  push:
    # Explicitly specifying this results in tags being ignored
    branches: ["**"]
    paths:
      - .github/workflows/qodana.yml
      - qodana.yaml
      - "**.props"
      - "src/**"
      - "tests/**"
      - "ci/**"

  pull_request:
    paths:
      - .github/workflows/qodana.yml
      - qodana.yaml
      - "**.props"
      - "src/**"
      - "tests/**"
      - "ci/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: read

jobs:
  #############################################
  pre-check:
    name: Check for Duplicate Runs
    uses: ./.github/workflows/reusable-precheck.yml

  #############################################
  qodana:
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'
    name: Qodana Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0 # avoid shallow clone for better analysis

      - name: Setup .NET & Tools
        uses: ./.github/actions/setup-dotnet

      - name: Run Qodana Analysis
        uses: JetBrains/qodana-action@27de2a744479d1d731934eeaf79287575ebc5dd3 # v2025.2.1
        with:
          upload-result: true
          # Only save cache on default branch to prevent cache storage explosion.
          # Feature branches can still read from master's cache for performance benefits.
          cache-default-branch-only: true
        env:
          QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@d198d2fabf39a7f36b5ce57ce70d4942944f006e # v3.31.0
        if: success() || failure()
        with:
          sarif_file: ${{ runner.temp }}/qodana/results/qodana.sarif.json
          category: qodana
