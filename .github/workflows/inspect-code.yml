# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Inspect Code

on:
  push:
    # Explicitly specifying this results in tags being ignored, which is the goal.
    branches: ["**"]
    paths:
      - .github/workflows/inspect-code.yml
      - "**.cs"
  pull_request:
    paths:
      - .github/workflows/inspect-code.yml
      - "**.cs"

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

env:
  baseRef: >-
    ${{ github.ref == 'refs/heads/master' && github.event.before ||
    (github.event.base_ref || github.event.pull_request.base.ref || 'master') }}

permissions: read-all

jobs:
  #############################################
  pre-check:
    uses: ./.github/workflows/reusable-precheck.yml

  # DISABLED: ReSharper CLI tools don't properly support SLNX format yet
  # This causes the tool to run in "solution-less mode" which limits functionality
  # and results in "No items were found to cleanup" errors (exit code 3)
  #
  # Related JetBrains YouTrack issues:
  # - RSRP-501603: "Resharper .slnx support failures/problems"
  # - RSRP-500988: "ReSharper build doesn't work for solution in slnx format"
  # - RSRP-501504: "Cannot resolve symbol from C++/CLR with slnx solution"
  #
  # See also: https://blog.jetbrains.com/dotnet/2024/10/04/support-for-slnx-solution-files/
  # Quote: "The .NET CLI and MSBuild don't yet support SLNX files"
  #
  # TODO: Re-enable when ReSharper CLI tools gain full SLNX support
  cleanup:
    needs: pre-check
    if: false && needs.pre-check.outputs.should_run == 'true' # Remove 'false &&' when above issue is resolved
    name: Resharper Code Cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0 # avoid shallow clone for GitVersion

      - name: Setup .NET & Tools
        uses: ./.github/actions/setup-dotnet

      - name: Run Code Cleanup
        run: >-
          dotnet jb cleanupcode Recyclarr.slnx
          --settings="Recyclarr.slnx.DotSettings"
          --profile="Recyclarr Cleanup"
          --include="**.cs"
          --no-updates
          --verbosity=TRACE
          --LogLevel=TRACE
          --debug

      - name: Check Diff
        run: |
          ci/diff_to_errors.sh
          set -o pipefail
          git diff --exit-code | tee code-cleanup.patch

      - name: Publish Patch File
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: failure()
        with:
          name: code-cleanup-patch-files
          path: "*.patch"

  style:
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'
    name: CSharpier Style
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Setup .NET & Tools
        uses: ./.github/actions/setup-dotnet

      - name: Run CSharpier
        run: dotnet csharpier check .
